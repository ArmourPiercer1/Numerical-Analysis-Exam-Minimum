name: Build LaTeX and Release PDFs

concurrency:
  group: release-${{ github.repository }}-${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: true

on:
  push:
    branches: ["main", "dev"]
    tags: ["v*"]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-latex:
    name: Build with Tectonic
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set build metadata
        id: meta
        run: echo "build_ts=$(date -u +'%Y%m%d-%H%M%S')" >> "$GITHUB_OUTPUT"

      - name: Setup Tectonic
        uses: wtfjoke/setup-tectonic@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Compile Main Document
        run: |
          # 编译第一个文档
          # --keep-intermediates: 保留中间文件(可选)
          # --outfmt pdf: 输出 pdf
          tectonic -X compile "Numerical_Analysis_Exam_Minimum.tex"

      - name: Compile Appendix
        run: |
          # 编译子目录文档
          tectonic -X compile "Exam Appendix/Exam_Appendix.tex"

      - name: Prepare Artifacts
        run: |
          mkdir -p dist
          # Tectonic 默认在源文件同级目录生成 PDF
          mv "Numerical_Analysis_Exam_Minimum.pdf" "dist/Numerical_Analysis_Exam_Minimum.pdf"
          mv "Exam Appendix/Exam_Appendix.pdf" "dist/Exam_Appendix.pdf"

      - name: Upload Workflow Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pdf-build-${{ steps.meta.outputs.build_ts }}
          path: dist/*.pdf
          retention-days: 5

      - name: Update Nightly Release
        if: github.ref == 'refs/heads/main'
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: nightly
          name: Nightly Build
          body: "Fast build via Tectonic at ${{ steps.meta.outputs.build_ts }}"
          artifacts: dist/*.pdf
          allowUpdates: true
          removeArtifacts: true
          replacesArtifacts: true
          prerelease: true
